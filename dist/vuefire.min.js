/*!
 * vuefire v2.0.0-alpha.7
 * (c) 2018 Eduardo San Martin Morote
 * Released under the MIT License.
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.Vuefire={})}(this,function(t){"use strict";var e=function(t,e,i){this.vm=t,this.key=e,this.source=i,this.initialValue=null};e.prototype.bind=function(){return new Promise(function(){throw new Error("[bind] must be implemented in children.")})},e.prototype._init=function(t){this.defineReactive(this.vm,this.key,t)},e.prototype.unbind=function(){this.off&&this.off(),this.vm[this.key]=this.initialValue};function i(t){if("function"!=typeof t)throw new Error("Must pass a function.");var e=function(){for(var i=[],n=arguments.length;n--;)i[n]=arguments[n];t.apply(void 0,i),e=function(){}};return e}function n(t){var e=t.exists?t.data():{};return Object.defineProperty(e,".id",{value:t.id}),e[".ref"]=t.ref,e}function o(t){for(var e=[];t;)e.unshift(t.id),t=t.parent;var i=t.firestore._databaseId;return e.unshift(i.database),e.unshift(i.projectId),t.firebase.segments.join("/")}var r=function(t){function e(e,i,n){if(t.apply(this,arguments),!this.source.firestore||!this.source.collection)throw new Error("Not a valid Firestore DocumentReference to bind.")}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.path=function(){return o(this.source)},e.prototype.init=function(){this._init(this.initialValue)},e.prototype.bind=function(){var t=this;return new Promise(function(e,o){var r=i(e),s=t.source.onSnapshot(function(e){t.vm[t.key]=n(e),r()},o);t.off=i(s)})},e}(e),s=function(t){function e(e,i,n){if(t.apply(this,arguments),!this.source.firestore||!this.source.where)throw new Error("Not a valid Firestore CollectionReference or Query to bind.");this.initialValue=[]}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.path=function(){return o(this.source)},e.prototype.init=function(){this._init(this.initialValue)},e.prototype.add=function(t,e){this.vm[this.key].splice(t,0,e)},e.prototype.update=function(t,e){this.vm[this.key].splice(t,1,e)},e.prototype.delete=function(t){this.vm[this.key].splice(t,1)},e.prototype.bind=function(){var t=this;return this.unbind(),new Promise(function(e,o){var r=i(e),s=t.source.onSnapshot(function(e){(i=e,"function"==typeof i.docChanges?i.docChanges():i.docChanges).forEach(function(e){switch(e.type){case"added":t.add(e.newIndex,n(e.doc));break;case"modified":var i=n(e.doc);e.oldIndex===e.newIndex?t.update(e.oldIndex,i):(t.delete(e.oldIndex),t.add(e.newIndex,i));break;case"removed":t.delete(e.oldIndex)}});var i;r()},o);t.off=i(s)})},e}(e);function u(t){return"function"==typeof t.key?t.key():t.key}function c(t){return"[object Object]"===Object.prototype.toString.call(t)}function f(t,e){for(var i=0;i<t.length;i++)if(t[i][".key"]===e)return i;return-1}function a(t){var e=t.val(),i=c(e)?e:{".value":e};i[".key"]=u(t),i[".ref"]=(n=t,"function"==typeof n.ref?n=n.ref():"object"==typeof n.ref&&(n=n.ref),n);var n;return i}var d,p=function(t){function e(e,i,n){if(t.apply(this,arguments),"function"!=typeof this.source.on)throw new Error("Not a valid source to bind.");this.initialValue=[]}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.init=function(){this._init(this.initialValue)},e.prototype.add=function(t,e){this.vm[this.key].splice(t,0,e)},e.prototype.update=function(t,e){this.vm[this.key].splice(t,1,e)},e.prototype.delete=function(t){return this.vm[this.key].splice(t,1)[0]},e.prototype.bind=function(){var t=this;this.unbind();var e=this.source.on("child_added",function(e,i){var n=i?f(t.initialValue,i)+1:0;t.add(n,a(e))}),n=this.source.on("child_removed",function(e){var i=f(t.initialValue,u(e));t.delete(i)}),o=this.source.on("child_changed",function(e){var i=f(t.initialValue,u(e));t.update(i,a(e))}),r=this.source.on("child_moved",function(e,i){var n=f(t.initialValue,u(e)),o=t.delete(n),r=i?f(t.initialValue,i)+1:0;t.add(r,o)});return this.off=i(function(){t.source.off("child_added",e),t.source.off("child_removed",n),t.source.off("child_changed",o),t.source.off("child_moved",r)}),this.source.once("value")},e}(e),h=function(t){function e(e,i,n){if(t.apply(this,arguments),"function"!=typeof this.source.on)throw new Error("Not a valid source to bind.");this.initialValue={}}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.init=function(){this._init(this.initialValue)},e.prototype.bind=function(){var t=this;this.unbind();var e=this.source.on("value",function(e){t.vm[t.key]=a(e)});return this.off=i(function(){t.source.off("value",e)}),this.source.once("value")},e}(e);e.prototype.defineReactive=function(t,e,i){e in t?t[e]=i:d.util.defineReactive(t,e,i)};function l(t,e,i){if(!c(i.source))throw new Error("VueFire: invalid Firebase binding source.");var n=new(source.firestore?source.where?s:r:i.asObject?h:p)(t,e,i.source,readyCallback.bind(t),cancelCallback.bind(t));return t.$firebaseBinders[e]=n,n.init(),n.bind()}function y(t){t.$firebaseBinders||d.util.defineReactive(t,"$firebaseBinders",Object.create(null))}var v={created:function(){y(this);function t(t,e){"function"==typeof e&&(e=e.call(this));for(var i in e)l(t,i,e[i])}t(this,this.$options.firebase),t(this,this.$options.firestore)},beforeDestroy:function(){if(this.$firebaseBinders){for(var t in this.$firebaseBinders)this.$firebaseBinders[t]&&this.$unbind(t);this.$firebaseBinders=null}}};function b(t){(d=t).mixin(v);var e=d.config.optionMergeStrategies;e.firebase=e.provide,d.prototype.$bindAsObject=function(t,e){return y(this),l(this,t,{source:e,asObject:!0})},d.prototype.$bindAsArray=function(t,e){return y(this),l(this,t,{source:e})},d.prototype.$unbind=function(t){!function(t,e){var i=t.$firebaseBinders[e];i&&(i.unbind(),delete t.$firebaseBinders[e])}(this,t)}}"undefined"!=typeof window&&window.Vue&&b(window.Vue),t.default=b,Object.defineProperty(t,"__esModule",{value:!0})});